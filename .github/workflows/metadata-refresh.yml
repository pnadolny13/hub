name: Metadata Refresh

on:
  workflow_dispatch:

jobs:
  # extract_airbyte:
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       source-name: ['source-s3', 'source-kafka']
  #   container:
  #     image: airbyte/${{ matrix.source-name }}:latest
  #   steps:
  #     - name: Get Airbyte Spec
  #       run: $AIRBYTE_ENTRYPOINT spec > extractor--${{ matrix.source-name }}--airbyte.json
  #       id: get-airbyte-stdout
  #     - name: Print
  #       run: cat extractor--${{ matrix.source-name }}--airbyte.json

  # metadata_refresh_pr:
  #   name: Metadata Refresh PR

  #   runs-on: ubuntu-latest

  #   steps:
  #   - uses: actions/checkout@v3.3.0

  #   - name: Get current date
  #     id: date
  #     run: echo "::set-output name=date::$(date +'%Y-%m-%d')"

  #   - name: Create Pull Request
  #     # This runs every time, even if theres failures. If theres no changes it wont open a PR.
  #     if: always()
  #     uses: peter-evans/create-pull-request@v4
  #     with:
  #       token: ${{ secrets.PAT }}
  #       commit-message: Refresh plugin metadata ${{ steps.date.outputs.date }}
  #       committer: GitHub <noreply@github.com>
  #       author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
  #       signoff: false
  #       branch: hub-bot-metadata-${{ steps.date.outputs.date }}-${{ github.run_id }}-${{ github.run_number }}-${{ github.run_attempt }}
  #       delete-branch: true
  #       title: '[Hub Bot] Refresh metadata ${{ steps.date.outputs.date }}'
  #       body: |
  #         Test
  #         - testing
  #       assignees: pnadolny13
  #       reviewers: pnadolny13
  #       draft: true

  sdk_variants:
    runs-on: ubuntu-latest
    outputs:
       matrix: ${{ steps.setmatrix.outputs.matrix }}
    steps:
      - name: Install hub_utils
        run: pipx install git+https://github.com/pnadolny13/hub-utils.git@github_action_commands

      - name: Get Variants List
        id: get-variants-list
        run: echo "VARIANTS=$(hub_utils get-variant-names $(pwd))" >> $GITHUB_OUTPUT

      - name: Set Dynamic Matrix
        id: setmatrix
        # ${{ steps.get-variants-list.outputs.VARIANTS }}
        run: |
           matrixStringifiedObject="{\"include\":[{\"source-name\":\"extractors/tap-snowflake/meltanolabs.yml\"},{\"source-name\":\"extractors/tap-cloudwatch/meltanolabs.yml\"}]}"
           echo "::set-output name=matrix::$matrixStringifiedObject"

  metadata_refresh:
    name: Metadata Refresh
    needs: sdk_variants
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.sdk_variants.outputs.matrix) }}
    steps:
    - uses: actions/checkout@v3.3.0

    - name: Install hub_utils
      run: pipx install git+https://github.com/pnadolny13/hub-utils.git@github_action_commands

    # - name: Get Airbyte Spec
    #   run: $AIRBYTE_ENTRYPOINT spec > extractor--${{ matrix.source-name }}--airbyte.json
    #   id: get-airbyte-stdout

    # - name: Get Variants List
    #   id: get-variants-list
    #   run: echo "VARIANTS=$(hub_utils get-variant-names $(pwd))" >> $GITHUB_OUTPUT

    - name: Extract Metadata
      run: hub_utils extract-metadata-v2 "/home/runner/work/hub/hub/_data/meltano/${{ matrix.source-name }}" $(pwd)/extract_data

    - name: Translate and Merge
      run: HUB_ROOT_PATH=$(pwd) hub_utils translate "/home/runner/work/hub/hub/_data/meltano/${{ matrix.source-name }}" $(pwd)/extract_data
